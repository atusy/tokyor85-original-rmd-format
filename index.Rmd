---
title: |
  R Markdownの \
  オリジナルフォーマットを \
  作ろう
subtitle: "Tokyo.R 85"
date: 2020-5-23
author: Atusy
output:
  revealjs::revealjs_presentation:
    keep_md: true
    self_contained: false
    center: true
    css: revealjs.css
    math: null
---

```{r setup, include=FALSE}
`%>%` <- magrittr::`%>%`
```


```{r knitr, include=FALSE}
library(knitr)
library(flextable)
opts_chunk$set(eval = FALSE, collapse = TRUE, comment = "#>")
```
# {#self-intro}


::: {.col style='width:300px'}

### ***Atusy***

![](https://github.com/atusy/presentation/blob/master/headphone.jpg?raw=true){width=300px}

:::

::: {.col style='width:600px'}

* R Markdown関係のコミッタ
* felp、ftExtra、minidownなどパッケージを作ってはTokyoRで紹介している
* Pythonでデータ分析してる \
  \@ HACARUS Inc.
* ![](https://icongr.am/feather/home.svg)
  [blog.atusy.net](https://blog.atusy.net)
* ![](https://icongr.am/feather/twitter.svg)
  [\@Atsushi776](https://twitter.com/Atsushi776)

:::

# ![](osakar_600_600.png){height=400px}

* Skype朝もく (毎平日7:30--10:00)
    * 途中参加・途中離脱OK
* 勉強会 (初回6/6)
* <https://osaka-r.connpass.com/>

# minidown on CRAN

`mini_document`

* 軽量CSSフレームワーク採用
* JavaScriptを最小限にしつつも高機能
    * `floating_toc`
    * `code_folding`
    * `code_download` (開発版)
    * など

<https://minidown.atusy.net>

# 今日のお題

YAMLフロントマターに書くアレの

オリジナル版を作れるようになろう

```yaml
output: html_document # アレ
```

## アレ is 関数


```{=html}
<blockquote class="twitter-tweet"><p lang="ja" dir="ltr"><a href="https://twitter.com/hashtag/TokyoR?src=hash&amp;ref_src=twsrc%5Etfw">#TokyoR</a> のスライド作るにあたってR Markdownユーザーに聞きたい。YAMLフロントマターの<br>output: html_document<br>のhtml_documentは関数だと</p>&mdash; atusy (@Atsushi776) <a href="https://twitter.com/Atsushi776/status/1261074199780548610?ref_src=twsrc%5Etfw">May 14, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
```


# フォーマット作ろうよ

YAMLシンプルにしたいやん?

```yaml
output: tokyor85down::simple_document
```

## 必要ある?

[R Markdownの内部とテンプレート開発 by kazutan氏](https://kazutan.github.io/HijiyamaR6/intoTheRmarkdown.html#/)

によると

> だいたいYAMLフロントマター指定すれば済むからフォーマット作らなくていいよ（意訳）

らしいが……

## コピペ撲滅委員会「あるよ！」

```yaml
output:
  word_document:
    toc: TRUE
    toc_depth: 2
    df_print: kable
    md_extensions: +east_asian_line_breaks
```

* コピペしたい?
* どこ変更したっけ?
* 勝手に弄られないと信じられる?

## YAMLで済む範囲も<br/>フォーマット化する価値あり

# Lv. 1: ラッパー定義 {#level-1}

`output`に指定する

`word_document`とかは

**関数**だから、

ラッパー書けば`output`に指定できる！

## `html_document`は関数だよ

YAML使わないなら↓な感じ。

```{r, eval=FALSE}
library(rmarkdown)
fmt <- word_document(
  toc = TRUE,
  toc_depth = 2,
  df_print = "kable",
  md_extensions = "+east_asian_line_breaks"
)
render("index.Rmd", output_format = fmt)
```

## 使い回す操作はパッケージ化しよう {#define-functions}

`output: tokyor85down::custom_word_document`

で済むようになるぞ！！

```{r, eval=FALSE}
custom_word_document <-function(
  toc = TRUE, toc_depth = 2, df_print = "kable",
  md_extensions = "+east_asian_line_breaks"
) {
  word_document(
    toc = toc, toc_depth, df_print = df_print,
    md_extensions = md_extensions, ...
  )
}
```

# Lv. 2: 依存ファイル追加 {#level-2-word}

**基本編（絶対パスOK）**

例えば \
`word_document`関数にオリジナルの \
`reference_docx`を指定したい

`<small>`{=html}
HTMLで`self_contained = FALSE`を使わない限りは、基本編で十分なはず。
`</small>`{=html}

## 依存ファイルをパッケージに追加

必要なファイルを \
パッケージの`inst`ディレクトリ以下の \
好きなところに保存しておく

* `inst`
    * `resources`
        * `style.css`
        * `style.docx`


## Wordのテンプレを差し替え

```{r, eval=FALSE}
# パッケージからテンプレを探す関数
find_docx <- function () {
  system.file(
    "inst", "resources", "style.docx",
    package = "tokyor85down")
}
```


```{r, eval=FALSE}
# docx()をreference_docxの既定値に変更
styled_word_document <- 
  function(reference_docx = find_docx(), ...) {
  word_document(
    reference_docx = reference_docx, ...)
}
```

## 注: system.fileは関数内で使おう {#use-system-file-in-function}

`system.file`を直接実行すると \
パッケージをバイナリ化した場合に \
バイナリ化したシステムのパスに \
固定されてしまう


```{r}
# NG
docx <- system.file(
  "inst", "resources", "style.docx",
  package = "tokyor85down")
```

# Lv. 3: 依存ファイル追加 {#level-2-html}

**応用編（絶対パスNG）**

たとえば

`html_document`関数にオリジナルの \
`css`を指定したい

## HTMLのCSS差し替え (BAD)

```{r, eval=FALSE}
find_css <- function () {
  system.file(
    "inst", "resources", "style.css",
    package = "tokyor85down")
}
styled_html_document <- 
  function(css = find_css(), ...) {
  html_document(css = css, ...)
}
```

## CSS追加との相性が悪い

```{r, eval=FALSE}
styled_html_document(css = "new.css")
```

は必要なCSSを無視してしまうので

```{r, eval=FALSE}
styled_html_document(
  css = c(find_css(), "new.css")
)
```

する必要がある。めんどい。

## 携帯性の悪いHTMLができる

```{r, eval=FALSE}
styled_html_document(
  self_contained = FALSE
)
```

↓

パッケージディレクトリ下にある \
CSSを絶対パスで参照

## extra_dependencies引数を使おう

CSSとかJavaScriptを指定しておくと、

* `self_contained = TRUE`なら依存ファイルを
    * HTMLファイルに丸ごと取り込む
* `self_contained = FALSE`なら依存ファイルを
    * `lib_dir`引数で指定した場所にコピーし
    * HTMLファイルから相対パスで参照する

## 依存ファイルリストを作る

ための**関数**を作る

```{r, eval=FALSE}
dep <- function() {
  list(htmltools::htmlDependency(
    name = "tokyor85down",
    version = "0.0.1",
    src = "./inst/resources/css",
    stylesheet = "style.css",
    package = "tokyor85down",
  ))
}
```

## ラッパー関数を書く

ことで依存ファイルリストを利用する

```{r}
styled_html_document <- function(
  extra_dependencies = NULL, ...
) {
  html_document(
    extra_dependencies = 
      append(dep(), extra_dependencies),
    ...
  )
}
```

## 注: htmlDependencyは関数内で使おう {#use-html-dependency-in-function}

参考: [`system.file`は関数内で使おう](#use-system-file-in-function)

```{r}
# NG
dep <- htmltools::htmlDependency(
  name = "tokyor85down",
  version = "0.0.1",
  src = "./inst/resources/css",
  stylesheet = "style.css",
  package = "tokyor85down",
)
```


# Lv. 3: output_format関数へ {#level-3}

もっと自在に前処理とか後処理したくなったら

`rmarkdown::output_format`関数を使おう

詳しくは↓

[R Markdownの内部とテンプレート開発 by kazutan氏](https://kazutan.github.io/HijiyamaR6/intoTheRmarkdown.html#/)


# Enjoy & Help Me!

- Stars
- Issues
- PRs
- Sponsors
